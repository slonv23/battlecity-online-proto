import org.apache.tools.ant.filters.ReplaceTokens

plugins {
    id 'java'
    id 'war'
    id 'org.akhikhl.gretty' version '1.4.2'
    id "com.moowork.node" version "1.2.0"
}

sourceCompatibility = 1.8
ext.springVersion = '4.3.8.RELEASE'
ext.webAppPort = 8080

repositories {
    mavenCentral()
}

dependencies {
    providedCompile 'javax.servlet:javax.servlet-api:3.1.0'
    testCompile group: 'junit', name: 'junit', version: '4.12'
    compile "org.springframework:spring-webmvc:$springVersion"
    compile "org.springframework:spring-websocket:$springVersion"
}

gretty {
    httpPort = webAppPort
}

task deleteEntry(type: Delete) {
    delete 'build/inplaceWebapp', 'index.html'
    followSymlinks = true
}

task filter(type: Copy) {
    from 'src/main/webapp'
    into 'build/inplaceWebapp'
    filter(ReplaceTokens, tokens: [port: webAppPort.toString()])
}

filter.dependsOn deleteEntry

processResources.dependsOn filter

task webpack(type: NpmTask) {
    args = ['run', 'build']
}

processResources.dependsOn 'webpack'